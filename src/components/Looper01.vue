<template>
  <div class="drum">
    <header>
      <div class="eODRBF">
        <div class="cdWhJh">
          <svg
            width="200px"
            viewBox="0 0 1032 260"
            version="1.1"
            xmlns="http://www.w3.org/2000/svg"
            xlink="http://www.w3.org/1999/xlink"
          >
            <g stroke="none" stroke-width="1" fill="none" fill-rule="evenodd">
              <g>
                <path
                  d="M166.153548,105.215548 C168.747042,110.401379 186.801754,147.300561 206.153214,187.19157 C225.604423,227.082578 241.66414,259.593749 241.863639,259.394294 C242.063139,259.194839 260.71635,201.851515 283.459302,132.042251 L324.655966,4.98938975 L301.115016,4.69020719 C288.247292,4.59047967 277.274815,4.78993471 276.875816,5.18884479 C276.377067,5.68748239 266.601588,36.7027412 255.030612,74.3000165 C243.559386,111.897292 233.684156,143.510916 233.185408,144.607918 C232.287659,146.801924 235.778902,153.982305 190.193247,58.2438857 C175.131029,26.6302617 162.562555,0.900561409 162.263306,1.00028893 C161.964056,1.19974397 146.303339,33.7109156 127.450629,73.3027412 C108.498168,112.794839 92.7377011,144.807373 92.3387019,144.408463 C91.9397027,144.009553 81.8649738,112.296202 69.8949988,74.0008339 L48.1495443,4.49075215 L23.8105952,4.49075215 C1.16739249,4.49075215 -0.428604173,4.59047967 0.0701447848,6.28584751 C2.66363936,14.4635042 77.7752324,254.108736 78.6729805,256.801379 C79.7702282,260.291842 80.0694776,259.793204 120.667643,178.016638 L161.465307,95.7414333 L166.153548,105.215548 Z"
                  fill="white"
                ></path>
                <path
                  d="M491.178482,252.321526 C510.529942,249.429428 521.502419,245.938965 536.764137,238.259946 C579.856047,216.120436 605.591493,171.143324 602.997998,122.476294 C600.105254,66.7286104 563.197832,22.6490463 507.637198,8.48773842 C491.776981,4.4986376 482.101251,4 420.854879,4 L363,4 L363,128.459946 C363,196.972752 363.299249,253.318801 363.698249,253.617984 C363.997498,254.016894 389.932444,254.316076 421.253878,254.316076 C472.92427,254.316076 479.408007,254.116621 491.178482,252.321526 Z"
                  fill="white"
                ></path>
                <path
                  d="M410.797998,209.957493 C410.299249,209.558583 410,172.958583 410,128.579837 L410,48 L440.722936,48 C472.842369,48 486.208841,48.8975477 495.685071,51.5901907 C524.313261,59.8675749 542.268224,75.4250681 551.345455,99.9580381 C555.734445,111.626158 557.031193,118.706812 556.931443,130.275204 C556.831693,145.932425 552.342952,160.19346 543.066222,174.354768 C532.193495,190.710082 515.13628,202.178747 493.291076,207.763488 C486.208841,209.558583 481.321101,209.857766 448.40367,210.256676 C428.154462,210.555858 411.196997,210.456131 410.797998,209.957493 Z"
                  fill="#202427"
                  fill-rule="nonzero"
                ></path>
                <path
                  d="M651.448707,252.822888 C697.632861,243.847411 726.261051,216.123161 737.333278,169.550409 C738.530275,164.564033 739.228524,154.790736 739.727273,135.144414 C740.525271,106.622343 741.722269,97.8463215 745.91176,86.3776567 C753.093745,67.1302452 772.445204,52.4702997 794.290409,49.8773842 C804.265388,48.5809264 803.666889,50.2762943 803.36764,26.1422343 L803.06839,5 L794.589658,5.09972752 C770.649708,5.39891008 741.522769,18.3634877 723.867056,36.7133515 C710.301084,50.6752044 701.922102,67.0305177 696.635363,89.2697548 C695.039366,96.0512262 694.540617,103.431063 693.842369,125.6703 C693.04437,155.488828 692.046872,162.968392 687.258882,174.237602 C679.079399,193.684469 662.321435,206.050681 639.478732,209.341689 L631.498749,210.53842 L631.1995,232.677929 L631,254.817439 L635.88774,254.817439 C638.680734,254.817439 645.663219,253.919891 651.448707,252.822888 Z"
                  fill="white"
                ></path>
                <path
                  d="M1031.60033,126.663868 C1031.79983,5.39520324 1031.70008,-0.289265422 1030.00434,0.00991713969 C1029.10659,0.209372181 1011.15163,10.5810343 990.10442,23.1467019 L952,45.9843041 L952,69.8191814 C952,89.1663204 952.299249,93.6540588 953.296747,93.2551487 C953.994996,92.9559662 961.276731,88.2687727 969.356464,82.6840316 C977.436197,77.0992904 984.318932,72.611552 984.518432,72.611552 C984.717932,72.611552 984.917431,113.499835 984.917431,163.363596 L984.917431,254.115639 L1008.15913,253.916184 L1031.30108,253.617002 L1031.60033,126.663868 Z"
                  fill="white"
                ></path>
                <polygon
                  fill="white"
                  points="905.799833 126.446866 905.799833 107 865.899917 107 826 107 826 126.446866 826 145.893733 865.899917 145.893733 905.799833 145.893733"
                ></polygon>
              </g>
            </g>
          </svg>
          <h1 class="gXeAGY">Web Drum Sequencer</h1>
        </div>
      </div>
    </header>
    <main>
      <div class="sc-bwzfXH eGhnou">
        <div class="sc-bwzfXH bxEFbu">
          <div class="sc-bwzfXH RLpEp">
            <div class="sc-bwzfXH jYLOyl" v-touch:tap="startSound">
              <button class="sc-kgoBCf jOEbCR" v-show="!playing">
                <span class="sc-ifAKCX fipIDk">PLAY</span>
                <svg
                  viewBox="0 0 452 396"
                  version="1.1"
                  width="1.1em"
                  height="0.9em"
                  xmlns="http://www.w3.org/2000/svg"
                >
                  <g
                    stroke="none"
                    stroke-width="1"
                    fill="none"
                    fill-rule="evenodd"
                  >
                    <g fill="#FFFFFF">
                      <rect
                        stroke="#FFFFFF"
                        x="0.5"
                        y="11.5"
                        width="131"
                        height="369"
                      ></rect>
                      <polygon
                        points="202.140625 0 202.140625 396 452 198"
                      ></polygon>
                    </g>
                  </g>
                </svg>
              </button>
              <button class="sc-kgoBCf jOEbCR end" v-show="playing">
                <span class="sc-ifAKCX fipIDk">Stop</span
                ><svg
                  width="0.9em"
                  height="0.9em"
                  viewBox="0 0 371 371"
                  version="1.1"
                  xmlns="http://www.w3.org/2000/svg"
                >
                  <g stroke="none" fill="none" fill-rule="evenodd">
                    <rect
                      fill="#FFFFFF"
                      x="0"
                      y="0"
                      width="371"
                      height="371"
                    ></rect>
                  </g>
                </svg>
              </button>
            </div>
            <div class="sc-kGXeez dzByyx">
              <label class="sc-iwsKbI evxBqc">BPM</label>
              <input
                class="bpm-text-input sc-gzVnrw jKWWsk"
                id="bpm"
                min="1"
                max="999"
                type="number"
                readonly
                v-model="bpmNum"
              />
            </div>
          </div>
          <div class="sc-bwzfXH zReSj">
            <div class="sc-dxgOiQ eOAkuI">
              <span class="sc-ifAKCX DBJA">PATTERNS</span
              ><button
                :class="
                  patternsNum === 1 ? 'sc-bxivhb frdVxq' : 'sc-bxivhb wxLcD'
                "
                @click="patternsNum = 1"
              >
                1</button
              ><button
                :class="
                  patternsNum === 2 ? 'sc-bxivhb frdVxq' : 'sc-bxivhb wxLcD'
                "
                @click="patternsNum = 2"
              >
                2</button
              ><button
                :class="
                  patternsNum === 3 ? 'sc-bxivhb frdVxq' : 'sc-bxivhb wxLcD'
                "
                @click="patternsNum = 3"
              >
                3</button
              ><button
                :class="
                  patternsNum === 4 ? 'sc-bxivhb frdVxq' : 'sc-bxivhb wxLcD'
                "
                @click="patternsNum = 4"
              >
                4</button
              ><button
                :class="
                  patternsNum === 5 ? 'sc-bxivhb frdVxq' : 'sc-bxivhb wxLcD'
                "
                @click="patternsNum = 5"
              >
                5</button
              ><button
                :class="
                  patternsNum === 6 ? 'sc-bxivhb frdVxq' : 'sc-bxivhb wxLcD'
                "
                @click="patternsNum = 6"
              >
                6</button
              ><button
                :class="
                  patternsNum === 7 ? 'sc-bxivhb frdVxq' : 'sc-bxivhb wxLcD'
                "
                @click="patternsNum = 7"
              >
                7</button
              ><button
                :class="
                  patternsNum === 8 ? 'sc-bxivhb frdVxq' : 'sc-bxivhb wxLcD'
                "
                @click="patternsNum = 8"
              >
                8
              </button>
            </div>
            <div class="dataSubmit">
              <div @click="editMusic()">Save</div>
            </div>
          </div>
        </div>
      </div>
      <div class="container">
        <div class="trackcontainer">
          <div class="trackNodeName">
            <div class="sc-bwzfXH jKNSgD">
              <div class="sc-bwzfXH jkaEgP">
                <div class="sc-bwzfXH jkdwEk">
                  <span class="sc-cSHVUG cYSnRy">Channels</span>
                </div>
                <div class="sc-bwzfXH eAnnxY">
                  <span class="sc-cSHVUG VkIKe">Hit</span>
                </div>
              </div>
            </div>
            <div v-for="(track, index) in tracks" class="track" :key="index">
              <div v-if="showTracks == index">
                <div
                  v-for="(tracker, index) in track"
                  class="track track_flex"
                  :key="index + 10"
                >
                  <div class="sc-bwzfXH track-name cAVscE">
                    <div class="sc-bwzfXH fhqfxo">
                      <span class="sc-ifAKCX fFLvkv">{{ tracker.name }}</span>
                    </div>
                    <button
                      class="sc-bxivhb bROAlo"
                      @click="addMusic(showTracks, tracker.res)"
                    ></button>
                  </div>
                </div>
              </div>
              <div v-else @click="showTracks = index" class="track_flex">
                <div class="sc-bwzfXH track-name cAVscE">
                  <div class="sc-bwzfXH fhqfxo">
                    <span class="sc-ifAKCX fFLvkv">{{
                      tracksName[index]
                    }}</span>
                  </div>
                  <img src="/img/right.svg" width="50" height="50" />
                </div>
              </div>
            </div>
          </div>
          <div class="trackNodeList">
            <!-- @mousewheel.prevent="stretchNote" -->
            <div class="listInfo">
              <div class="sc-bwzfXH jKNSgD">
                <div
                  v-for="(n, index) in parseInt(notevalue)"
                  :key="index + 30"
                  :class="{ ticker: true, active: n <= current }"
                ></div>
              </div>
              <div v-for="(track, index) in tracks" class="track" :key="index">
                <div v-if="showTracks == index">
                  <div
                    v-for="(tracker, index) in track"
                    class="track track_flex"
                    :key="index + 10"
                  >
                    <div
                      :style="[
                        tracker.activate[n - 1]
                          ? {
                              background:
                                'linear-gradient(180deg,rgba(213,255,169,1) 0%,rgba(152,255,193,1) 100%)',
                            }
                          : {
                              backgroundColor: '#DDD',
                            },
                        tracker.info[n - 1] &&
                        tracker.info[n - 1].owner.toLowerCase() === address
                          ? {
                              opacity: '1',
                            }
                          : {
                              opacity: '0.5',
                            },
                      ]"
                      v-touch:tap="toggleActivate(tracker, index, n)"
                      :ref="n"
                      :class="{
                        playsound: tracker.activate[n - 1],
                        block: true,
                        active: n == current,
                      }"
                      :key="n + 's'"
                      v-for="n in parseInt(notevalue)"
                      :id="tracker.id + n"
                      @mouseover="mouseOverNode(tracker.id, n)"
                      @mouseleave="mouseLeaveNode(tracker.id, n)"
                      @click="enlargeNote(tracker.id + n, tracker, n, index)"
                    >
                      &#160;
                    </div>
                  </div>
                </div>
                <div v-else @click="showTracks = index" class="track_flex">
                  <div
                    :style="[
                      check(track, n - 1)
                        ? {
                            background:
                              'linear-gradient(rgb(244, 255, 70) 0%, rgb(247, 217, 0) 100%)',
                          }
                        : {
                            backgroundColor: '#DDD',
                          },
                    ]"
                    :class="{
                      playsound: check(track, n - 1),
                      block: true,
                      active: n == current,
                    }"
                    :key="n + 't'"
                    v-for="n in parseInt(notevalue)"
                  >
                    &#160;
                  </div>
                </div>
              </div>
            </div>
          </div>
        </div>
      </div>
    </main>
  </div>
</template>

<script>
/* eslint-disable */
import * as Tone from "tone";
import $ from "jquery";
import { abi } from "../assets/abi";
var Contract = require("web3-eth-contract");
Contract.setProvider(window.ethereum);
let re4mContract = new Contract(
  abi,
  "0x9a055D0db005ce1f9CC41f97C95D9EC34b4786b2"
);
export default {
  data() {
    return {
      loading: true,
      current: 0,
      notevalue: 480,
      playing: false,
      bpm: 30,
      tracks: [
        [
          { id: "Kick1", name: "Kick 1", res: "type1", activate: [], info: [] },
          { id: "Kick2", name: "Kick 2", res: "type2", activate: [], info: [] },
          {
            id: "Percussion1",
            name: "Percussion 1",
            res: "type3",
            activate: [],
            info: [],
          },
          {
            id: "Percussion2",
            name: "Percussion 2",
            res: "type4",
            activate: [],
            info: [],
          },
          {
            id: "RimshotSnare1",
            name: "Rimshot Snare 1",
            res: "type5",
            activate: [],
            info: [],
          },
          {
            id: "RimshotSnare2",
            name: "Rimshot Snare 2",
            res: "type6",
            activate: [],
            info: [],
          },
          {
            id: "Snare1",
            name: "Snare 1",
            res: "type7",
            activate: [],
            info: [],
          },
          {
            id: "Snare2",
            name: "Snare 2",
            res: "type8",
            activate: [],
            info: [],
          },
        ],
        [
          {
            id: "ClosedHihat1",
            name: "Closed Hihat 1",
            res: "type1",
            activate: [],
            info: [],
          },
          {
            id: "ClosedHihat2",
            name: "Closed Hihat 2",
            res: "type2",
            activate: [],
            info: [],
          },
          {
            id: "Crash1",
            name: "Crash 1",
            res: "type3",
            activate: [],
            info: [],
          },
          {
            id: "Crash2",
            name: "Crash 2",
            res: "type4",
            activate: [],
            info: [],
          },
          {
            id: "OpenHihat1",
            name: "Open Hihat 1",
            res: "type5",
            activate: [],
            info: [],
          },
          {
            id: "OpenHihat2",
            name: "Open Hihat 2",
            res: "type6",
            activate: [],
            info: [],
          },
          { id: "Ride1", name: "Ride 1", res: "type7", activate: [], info: [] },
          { id: "Ride2", name: "Ride 2", res: "type8", activate: [], info: [] },
        ],
        [
          {
            id: "Plucks1",
            name: "Plucks 1",
            res: "type1",
            activate: [],
            info: [],
          },
          {
            id: "Plucks2",
            name: "Plucks 2",
            res: "type2",
            activate: [],
            info: [],
          },
          {
            id: "Plucks3",
            name: "Plucks 3",
            res: "type3",
            activate: [],
            info: [],
          },
          {
            id: "Plucks4",
            name: "Plucks 4",
            res: "type4",
            activate: [],
            info: [],
          },
          {
            id: "Plucks5",
            name: "Plucks 5",
            res: "type5",
            activate: [],
            info: [],
          },
          {
            id: "Plucks6",
            name: "Plucks 6",
            res: "type6",
            activate: [],
            info: [],
          },
          {
            id: "Plucks7",
            name: "Plucks 7",
            res: "type7",
            activate: [],
            info: [],
          },
          {
            id: "Plucks8",
            name: "Plucks 8",
            res: "type8",
            activate: [],
            info: [],
          },
        ],
        [
          {
            id: "Plucks1",
            name: "Plucks 1",
            res: "type1",
            activate: [],
            info: [],
          },
          {
            id: "Plucks2",
            name: "Plucks 2",
            res: "type2",
            activate: [],
            info: [],
          },
          {
            id: "Plucks3",
            name: "Plucks 3",
            res: "type3",
            activate: [],
            info: [],
          },
          {
            id: "Plucks4",
            name: "Plucks 4",
            res: "type4",
            activate: [],
            info: [],
          },
          {
            id: "Plucks5",
            name: "Plucks 5",
            res: "type5",
            activate: [],
            info: [],
          },
          {
            id: "Plucks6",
            name: "Plucks 6",
            res: "type6",
            activate: [],
            info: [],
          },
          {
            id: "Plucks7",
            name: "Plucks 7",
            res: "type7",
            activate: [],
            info: [],
          },
          {
            id: "Plucks8",
            name: "Plucks 8",
            res: "type8",
            activate: [],
            info: [],
          },
        ],
        [
          {
            id: "Plucks1",
            name: "Plucks 1",
            res: "type1",
            activate: [],
            info: [],
          },
          {
            id: "Plucks2",
            name: "Plucks 2",
            res: "type2",
            activate: [],
            info: [],
          },
          {
            id: "Plucks3",
            name: "Plucks 3",
            res: "type3",
            activate: [],
            info: [],
          },
          {
            id: "Plucks4",
            name: "Plucks 4",
            res: "type4",
            activate: [],
            info: [],
          },
          {
            id: "Plucks5",
            name: "Plucks 5",
            res: "type5",
            activate: [],
            info: [],
          },
          {
            id: "Plucks6",
            name: "Plucks 6",
            res: "type6",
            activate: [],
            info: [],
          },
          {
            id: "Plucks7",
            name: "Plucks 7",
            res: "type7",
            activate: [],
            info: [],
          },
          {
            id: "Plucks8",
            name: "Plucks 8",
            res: "type8",
            activate: [],
            info: [],
          },
        ],
        [
          {
            id: "Plucks1",
            name: "Plucks 1",
            res: "type1",
            activate: [],
            info: [],
          },
          {
            id: "Plucks2",
            name: "Plucks 2",
            res: "type2",
            activate: [],
            info: [],
          },
          {
            id: "Plucks3",
            name: "Plucks 3",
            res: "type3",
            activate: [],
            info: [],
          },
          {
            id: "Plucks4",
            name: "Plucks 4",
            res: "type4",
            activate: [],
            info: [],
          },
          {
            id: "Plucks5",
            name: "Plucks 5",
            res: "type5",
            activate: [],
            info: [],
          },
          {
            id: "Plucks6",
            name: "Plucks 6",
            res: "type6",
            activate: [],
            info: [],
          },
          {
            id: "Plucks7",
            name: "Plucks 7",
            res: "type7",
            activate: [],
            info: [],
          },
          {
            id: "Plucks8",
            name: "Plucks 8",
            res: "type8",
            activate: [],
            info: [],
          },
        ],
        [
          {
            id: "Plucks1",
            name: "Plucks 1",
            res: "type1",
            activate: [],
            info: [],
          },
          {
            id: "Plucks2",
            name: "Plucks 2",
            res: "type2",
            activate: [],
            info: [],
          },
          {
            id: "Plucks3",
            name: "Plucks 3",
            res: "type3",
            activate: [],
            info: [],
          },
          {
            id: "Plucks4",
            name: "Plucks 4",
            res: "type4",
            activate: [],
            info: [],
          },
          {
            id: "Plucks5",
            name: "Plucks 5",
            res: "type5",
            activate: [],
            info: [],
          },
          {
            id: "Plucks6",
            name: "Plucks 6",
            res: "type6",
            activate: [],
            info: [],
          },
          {
            id: "Plucks7",
            name: "Plucks 7",
            res: "type7",
            activate: [],
            info: [],
          },
          {
            id: "Plucks8",
            name: "Plucks 8",
            res: "type8",
            activate: [],
            info: [],
          },
        ],
        [
          {
            id: "Plucks1",
            name: "Plucks 1",
            res: "type1",
            activate: [],
            info: [],
          },
          {
            id: "Plucks2",
            name: "Plucks 2",
            res: "type2",
            activate: [],
            info: [],
          },
          {
            id: "Plucks3",
            name: "Plucks 3",
            res: "type3",
            activate: [],
            info: [],
          },
          {
            id: "Plucks4",
            name: "Plucks 4",
            res: "type4",
            activate: [],
            info: [],
          },
          {
            id: "Plucks5",
            name: "Plucks 5",
            res: "type5",
            activate: [],
            info: [],
          },
          {
            id: "Plucks6",
            name: "Plucks 6",
            res: "type6",
            activate: [],
            info: [],
          },
          {
            id: "Plucks7",
            name: "Plucks 7",
            res: "type7",
            activate: [],
            info: [],
          },
          {
            id: "Plucks8",
            name: "Plucks 8",
            res: "type8",
            activate: [],
            info: [],
          },
        ],
        [
          {
            id: "Plucks1",
            name: "Plucks 1",
            res: "type1",
            activate: [],
            info: [],
          },
          {
            id: "Plucks2",
            name: "Plucks 2",
            res: "type2",
            activate: [],
            info: [],
          },
          {
            id: "Plucks3",
            name: "Plucks 3",
            res: "type3",
            activate: [],
            info: [],
          },
          {
            id: "Plucks4",
            name: "Plucks 4",
            res: "type4",
            activate: [],
            info: [],
          },
          {
            id: "Plucks5",
            name: "Plucks 5",
            res: "type5",
            activate: [],
            info: [],
          },
          {
            id: "Plucks6",
            name: "Plucks 6",
            res: "type6",
            activate: [],
            info: [],
          },
          {
            id: "Plucks7",
            name: "Plucks 7",
            res: "type7",
            activate: [],
            info: [],
          },
          {
            id: "Plucks8",
            name: "Plucks 8",
            res: "type8",
            activate: [],
            info: [],
          },
        ],
        [
          {
            id: "Plucks1",
            name: "Plucks 1",
            res: "type1",
            activate: [],
            info: [],
          },
          {
            id: "Plucks2",
            name: "Plucks 2",
            res: "type2",
            activate: [],
            info: [],
          },
          {
            id: "Plucks3",
            name: "Plucks 3",
            res: "type3",
            activate: [],
            info: [],
          },
          {
            id: "Plucks4",
            name: "Plucks 4",
            res: "type4",
            activate: [],
            info: [],
          },
          {
            id: "Plucks5",
            name: "Plucks 5",
            res: "type5",
            activate: [],
            info: [],
          },
          {
            id: "Plucks6",
            name: "Plucks 6",
            res: "type6",
            activate: [],
            info: [],
          },
          {
            id: "Plucks7",
            name: "Plucks 7",
            res: "type7",
            activate: [],
            info: [],
          },
          {
            id: "Plucks8",
            name: "Plucks 8",
            res: "type8",
            activate: [],
            info: [],
          },
        ],
      ],
      tracksName: [
        "Drum",
        "Cymbal",
        "Plucks",
        "other4",
        "other5",
        "other6",
        "other7",
        "other8",
        "other9",
        "other10",
      ],
      drums: null,
      Cymbals: null,
      Plucks: null,
      other4: null,
      other5: null,
      other6: null,
      other7: null,
      other8: null,
      other9: null,
      other10: null,

      showTracks: 0,

      bpmNum: 30,
      patternsNum: 1,

      stretchNum: 10,
      tickeNum: 20.1,

      address: "",

      dataRowsList: [],
      dataColumnList: [],

      upDataLst: [],
    };
  },
  computed: {
    instruments() {
      return [ 
        this.drums,
        this.Cymbals,
        this.Plucks,
        this.other4,
        this.other5,
        this.other6,
        this.other7,
        this.other8,
        this.other9,
        this.other10,
      ];
    },
  },
  async created() {
    this.connect();
    this.getDataList();
  },
  mounted() {
    this.init();
  },
  watch: {
    bpm: {
      handler: function (val, oldVal) {
        Tone.Transport.bpm.value = this.bpm;
      },
    },
    notevalue: {
      handler: function (val, oldVal) {
        Tone.Transport.stop();
        Tone.Transport.cancel();
        Tone.Loop.interval = this.notevalue + "n";
        this.playing = false;
        // this.$forceUpdate();
      },
    },
  },
  methods: {
    check(track, index) {
      let a = track.find((item) => {
        return item.activate[index] == true;
      });
      return a != undefined;
    },
    toggleActivate: function (track, index, n) {
      const that = this;
      return () => {
        if (track.info[n - 1]) {
          if (track.info[n - 1].owner.toLowerCase() === that.address) {
            track.activate[n - 1] = !track.activate[n - 1];
          }
        }
        this.$forceUpdate(); 
      };
    },
    setMeasure: function (measure) {
      return () => {
        this.notevalue = measure;
      };
    },
    addMusic(index, e) {
      let player = new Tone.Player().toDestination();
      player.buffer = this.instruments[index].get(e);
      console.log("player", player);
      player.start();
    },
    async startSound() {
      if (!this.playing) {
        Tone.start();
        this.loop = new Tone.Loop((time) => {
          Tone.Draw.schedule(() => {
            this.current++;
            if (this.current > this.notevalue) this.current = 1;
            for (let j = 0; j < this.tracks.length; j++) {
              for (let i = 0; i < this.tracks[j].length; i++) {
                if (this.tracks[j][i].activate[this.current - 1]) {
                  this.addMusic(j, this.tracks[j][i].res);
                }
              }
            }
          }, time);
        }, this.notevalue + "n").start(0);

        Tone.Transport.bpm.value = 480 / this.notevalue;
        Tone.Transport.start();
      } else {
        Tone.Transport.stop();
        Tone.Transport.cancel();
      }
      this.playing = !this.playing;
    },
    init: function () {
      this.drums = new Tone.ToneAudioBuffers({
        urls: {
          type1: "Kick2.wav",
          type2: "Kick2.wav",
          type3: "drum3.wav",
          type4: "drum5.wav",
          type5: "drum5.wav",
          type6: "drum6.wav",
          type7: "drum7.wav",
          type8: "drum8.wav",
        },
        onload: () => console.log("drums loaded"),
        baseUrl: "/api",
      });
      this.Cymbals = new Tone.ToneAudioBuffers({
        urls: {
          type1: "Cymbals1.wav",
          type2: "Cymbals2.wav",
          type3: "Cymbals3.wav",
          type4: "Cymbals4.wav",
          type5: "Cymbals5.wav",
          type6: "Cymbals6.wav",
          type7: "Cymbals7.wav",
          type8: "Cymbals8.wav",
        },
        onload: () => console.log("Cymbals loaded"),
        baseUrl: "/api",
      });
      this.Plucks = new Tone.ToneAudioBuffers({
        urls: {
          type1: "pluck (1).wav",
          type2: "pluck (2).wav",
          type3: "pluck (3).wav",
          type4: "pluck (4).wav",
          type5: "pluck (5).wav",
          type6: "pluck (6).wav",
          type7: "pluck (7).wav",
          type8: "pluck (8).wav",
        },
        onload: () => console.log("Plucks loaded"),
        baseUrl: "/api",
      });
      this.other4 = new Tone.ToneAudioBuffers({
        urls: {
          type1: "Kick2.wav",
          type2: "Kick2.wav",
          type3: "drum3.wav",
          type4: "drum5.wav",
          type5: "drum5.wav",
          type6: "drum6.wav",
          type7: "drum7.wav",
          type8: "drum8.wav",
        },
        onload: () => console.log("drums loaded"),
        baseUrl: "/api",
      });
      this.other5 = new Tone.ToneAudioBuffers({
        urls: {
          type1: "Cymbals1.wav",
          type2: "Cymbals2.wav",
          type3: "Cymbals3.wav",
          type4: "Cymbals4.wav",
          type5: "Cymbals5.wav",
          type6: "Cymbals6.wav",
          type7: "Cymbals7.wav",
          type8: "Cymbals8.wav",
        },
        onload: () => console.log("Cymbals loaded"),
        baseUrl: "/api",
      });
      this.other6 = new Tone.ToneAudioBuffers({
        urls: {
          type1: "pluck (1).wav",
          type2: "pluck (2).wav",
          type3: "pluck (3).wav",
          type4: "pluck (4).wav",
          type5: "pluck (5).wav",
          type6: "pluck (6).wav",
          type7: "pluck (7).wav",
          type8: "pluck (8).wav",
        },
        onload: () => console.log("Plucks loaded"),
        baseUrl: "/api",
      });
      this.other7 = new Tone.ToneAudioBuffers({
        urls: {
          type1: "Kick2.wav",
          type2: "Kick2.wav",
          type3: "drum3.wav",
          type4: "drum5.wav",
          type5: "drum5.wav",
          type6: "drum6.wav",
          type7: "drum7.wav",
          type8: "drum8.wav",
        },
        onload: () => console.log("drums loaded"),
        baseUrl: "/api",
      });
      this.other8 = new Tone.ToneAudioBuffers({
        urls: {
          type1: "Cymbals1.wav",
          type2: "Cymbals2.wav",
          type3: "Cymbals3.wav",
          type4: "Cymbals4.wav",
          type5: "Cymbals5.wav",
          type6: "Cymbals6.wav",
          type7: "Cymbals7.wav",
          type8: "Cymbals8.wav",
        },
        onload: () => console.log("Cymbals loaded"),
        baseUrl: "/api",
      });
      this.other9 = new Tone.ToneAudioBuffers({
        urls: {
          type1: "pluck (1).wav",
          type2: "pluck (2).wav",
          type3: "pluck (3).wav",
          type4: "pluck (4).wav",
          type5: "pluck (5).wav",
          type6: "pluck (6).wav",
          type7: "pluck (7).wav",
          type8: "pluck (8).wav",
        },
        onload: () => console.log("Plucks loaded"),
        baseUrl: "/api",
      });
      this.other10 = new Tone.ToneAudioBuffers({
        urls: {
          type1: "Kick2.wav",
          type2: "Kick2.wav",
          type3: "drum3.wav",
          type4: "drum5.wav",
          type5: "drum5.wav",
          type6: "drum6.wav",
          type7: "drum7.wav",
          type8: "drum8.wav",
        },
        onload: () => console.log("drums loaded"),
        baseUrl: "/api",
      });
    },
    mouseOverNode(name, id) {
      $("#" + name + id).addClass("bigNode");

      $("#" + name + (id - 1)).addClass("bigNode2");
      $("#" + name + (id - 2)).addClass("bigNode3");

      $("#" + name + (id + 1)).addClass("bigNode2");
      $("#" + name + (id + 2)).addClass("bigNode3");
    },
    mouseLeaveNode(name, id) {
      $("#" + name + id).removeClass("bigNode");

      $("#" + name + (id - 1)).removeClass("bigNode2");
      $("#" + name + (id - 2)).removeClass("bigNode3");

      $("#" + name + (id + 1)).removeClass("bigNode2");
      $("#" + name + (id + 2)).removeClass("bigNode3");
    },
    enlargeNote(id, tracker, n, index) {
      if (tracker.info[n - 1]) {
        if (tracker.info[n - 1].owner.toLowerCase() === this.address) {
          $("#" + id).addClass("bigNode");
          console.log(tracker);
          let str = tracker.info[n - 1].value;
          if (
            tracker.activate[n - 1] === 1 ||
            tracker.activate[n - 1] === true
          ) {
            tracker.info[n - 1].value = this.replaceStr(
              str,
              index + 2 + (index + 1),
              1
            );
            console.log(tracker.info[n - 1].value);
          } else {
            tracker.info[n - 1].value = this.replaceStr(
              str,
              index + 2 + (index + 1),
              0
            );
            console.log(tracker.info[n - 1].value);
          }
          if (this.upDataLst.length > 0) {
            let valuearr = {
              id: tracker.info[n - 1].token_id,
              key: tracker.info[n - 1].value,
            };
            for (let i = 0; i < this.upDataLst.length; i++) {
              if (this.upDataLst[i].id === tracker.info[n - 1].token_id) {
                this.upDataLst[i].key = tracker.info[n - 1].value;
                return;
              }
            }
            this.upDataLst = this.upDataLst.concat(valuearr);
          } else {
            this.upDataLst = [
              {
                id: tracker.info[n - 1].token_id,
                key: tracker.info[n - 1].value,
              },
            ];
          }
          console.log(this.upDataLst);
        }
      }
    },

    replaceStr(str, n, char) {
      const strAry = str.split("");
      strAry[n] = char;
      return strAry.join("");
    },

    stretchNote() {
      console.log(event.wheelDelta);
      if (event.wheelDelta > 0) {
        if (this.stretchNum >= 10 && this.stretchNum < 30) {
          var num = this.stretchNum + 5;
          $(".block").height(num);
          $(".block").width(num);
          this.stretchNum = num;

          var tickeNum = this.tickeNum + 5;
          $(".ticker").width(tickeNum);
          this.tickeNum = tickeNum;
        }
      } else {
        if (this.stretchNum <= 30 && this.stretchNum > 10) {
          var num = this.stretchNum - 5;
          $(".block").height(num);
          $(".block").width(num);
          this.stretchNum = num;

          var tickeNum = this.tickeNum - 5;
          $(".ticker").width(tickeNum);
          this.tickeNum = tickeNum;
        }
      }
      return false;
    },
    async connect() {
      const that = this;
      if (window.ethereum) {
        await window.ethereum
          .request({
            method: "eth_requestAccounts",
          })
          .then(async (res) => {
            this.address = res[0];
            //this.notevalue = Number(await re4mContract.methods.totalSupply().call());
            //console.log("rows:" + this.notevalue);

            //mintNote
            //this.mintNote();

            //getBlockOfUser
            //let getblock = await re4mContract.methods.getBlockOfUser(this.address).call();
            //console.log("user block:" + getblock);

            //ownerOf
            //let ownerAddress = await re4mContract.methods.ownerOf(5).call();
            //console.log("ownerAddress:" + ownerAddress);

            //getMetaSong
            //let byts = await re4mContract.methods.getMetaSong(6, 7).call();
            //0x 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00
            //console.log("byts:" + byts);
          })
          .catch((error) => {
            if (error.code === 4001) {
              console.log("Please connect to Ethereum.");
              // that.alert = "Please connect to Ethereum.";
              // that.showTips = true;
              // setTimeout(() => {
              //   that.showTips = false;
              // }, 3000);
            } else {
              console.error(error);
            }
          });

        window.ethereum.on("accountsChanged", async (accounts) => {
          if (accounts.length > 0) {
            this.address = accounts[0];
          }
        });
      } else {
        console.log("Failed to detect any ETH wallet.");
        // this.alert = "Failed to detect any ETH wallet.";
        // this.showTips = true;
        // setTimeout(() => {
        //   this.showTips = false;
        // }, 3000);
      }
    },
    async mintNote() {
      let result = await re4mContract.methods.mintNote(10).send({
        from: this.address,
      });
      if (result.status == true) {
        console.log("Success.");
      }
    },
    async editMusic() {
      if (this.upDataLst.length > 0) {
        let idArr = [];
        let keyArr = [];
        for (let i = 0; i < this.upDataLst.length; i++) {
          if (idArr) {
            idArr = idArr.concat(this.upDataLst[i].id);
            keyArr = keyArr.concat(this.upDataLst[i].key);
          } else {
            idArr = this.upDataLst[i].id;
            keyArr = this.upDataLst[i].key;
          }
        }
        console.log(idArr);
        console.log(keyArr);
        let result = await re4mContract.methods.editMusic(idArr, keyArr).send({
          from: this.address,
        });
        if (result.status == true) {
          console.log("Success.");
          setTimeout(() => {
            this.getDataList();
          }, 3000 * 2);
        }
      } else {
        console.log("not changed");
      }
    },
    getDataList: function () {
      this.$axios
        .get("http://138.197.192.223:49001/api/info", {})
        .then((res) => {
          this.dataRowsList = res.data.data.row;
          this.dataColumnList = res.data.data.column;
          let current = 0;
          for (let j = 0; j < this.tracks.length; j++) {
            for (let i = 0; i < this.tracks[j].length; i++) {
              current++;
              this.tracks[j][i].activate = this.dataColumnList[current - 1];
              this.tracks[j][i].info = this.dataRowsList[j];
            }
          }
          console.log(this.tracks);
        });
    },
  },
};
</script>

<style scoped lang="scss">
@import "../assets/style01.scss";
</style>
